name: Docker GCR build and push
# This workflow is triggered on pushes to the repository.
on:
  push:
    branches:    
      - master
    
  workflow_dispatch:
    inputs:
      gcr_host:
        description: 'Google Container Registry Host'
        required: true
        default: 'gcr.io'
      image_name:
        description: 'Name of the image. Should be specified without domain and project.'
        required: true
        default: 'btc-node-proxy'
      image_tag:
        description: 'Image tag to set for the built image.'
        required: true
        default: 'latest'

env:
  GOOGLE_PROJECT_ID: nodehodl
  GCLOUD_SERVICE_KEY: '{
    "type": "service_account",
    "project_id": "nodehodl",
    "private_key_id": "98dd617d54bcb7ff7e076115b60bb1a79c3d97fa",
    "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDe4zAid09s78S4\naAjU2rfqSYtReUOcqMWoyCStgDjDBIwvnVnv8nUkPsbJOBarX/phpHP1eqnBqz6A\nMhGLpshBpTa/jKfOpfTdFbNzQGUpWGTbDkmFld0IWNffKDYQVI5Y2N3wxZT69NYE\nnQYeA1EZrI5WiKqwZ6oNccpO/pX6Meoo2bpM4DgAnR6xNXHIEUrKKA0JGqEFspR/\nAKmEFYiBQJkDZmzEQorPnJW8j7HoH/aUjDJVOZ0Nu72+GjWpHz6NxVH5FIwucZVb\n9ubJLfNnPT1DjjoZZNWHLZhW3wKHNpcc+VGRn0r7rGTp/i6qtlvSiGUIP29ZvQrt\nYEMt8mzdAgMBAAECggEAGPImhgUCf7fKNbV3H5OnN/KpRCIlXhhJnx1fdYe/Upxk\nsEOVOFTTpY3dI9JCP0YLuPf1/oiPDV0ELsbrzcyJ50b9fKzabzeF02TFY+XWLK13\nBElyEyB1z6RZ7OEMRAGiuPD0zijfBsN2XKfScnN+lTgJ6kd7iyjfEIgm03aNBKZy\nBCOpwNTN5Mkin3R9y6dgWLpR4rGiFB94217+szOU2tMefW3rhvikw3IofRRUg7SL\n4n+S+5v8YrgtDSWDlvvIncLHXya7220+e8ej0qomb2y1UENKML051wdjMEfA048M\nsdQO/j3QosvS//XV9tdRYsXt3i3CbiAbCkK9AVd9wQKBgQD3zeC8UYzFIYb92D7C\nQuV6rSM4pZ2wlWdKfvaxii4D7rxWGt9Egi9hndVBdhxUnPU+eYIrR09BjjTcrgAP\nJm3QDo4Jp6VPqrJ3Wqld+V1M6fb+xDX0vTeqIHJtf9SOvPYJZ/WuLi25qNFof1ls\nOLpjc2k902S+bCvyzRF2XHMCMQKBgQDmQlf2QFdMJTycKuhVHwJrjzojIAp4qpg/\nL68nQqnYdeYLHftzDhnfBr+MbEFCspydrxLpGk50QNwUtJJTBuupJZNzqvPKasnn\noNTuDKYRRE+Jd1TVtdKvfkgORH4uSnu8sDTa592Fb5kQmNLU61Njwl6dsS9o7lDe\nzkNO7VTebQKBgDCRlIO0hB+7E4c7VAmlLO8fcjDPHRoYHleWjOl9SMmSiC1kNPBr\nh7fdRIgBC0p2PQcSr7Wl013o7ml2XSKbCJjn0WUJC7iSn0oPZfS6RFQn4zZJ5L1k\nPL3GgEb/7/xOAvcS/i82c9XYxbpyg2dXswh8/VqVzUAZWX/MO6j0M8JxAoGBAKgN\n09VOsGhK5Sm1x0wZDdMi/fOU9w+KswOq8dNdvEjYA8YpY9RdflRgwHzkpdzgL56G\noO6w3IHMtNQH1qPycR1K54uMQdKCjkoYAFCdurbvfH2AMtKnmdWr/TsskkuG4Tie\nAnWitPMmuDh80aPE/V/aBORi5Y9YIH39XPLGFSMhAoGBAIM6IlHQfXTWRA/77UoI\ncGRiyHI/WZuQcLq//K82eSR9I/amS5i+KvJMlADnjk/FUYEIti8M+gYQV9PGD3ug\n5lXF2iRt7M0mNZ2+K1gWnTVgRCwbSUhvszn69Gh3WFTg43UTSfv0Bq/D124Yey9i\n0yiGrZXdEVNG3vKP3gLm1oQV\n-----END PRIVATE KEY-----\n",
    "client_email": "gcr-registry@nodehodl.iam.gserviceaccount.com",
    "client_id": "112871335765719747688",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/gcr-registry%40nodehodl.iam.gserviceaccount.com"
  }'

jobs:

  docker:
    name: Push image to docker registry
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Build and push docker image to GCR
        uses: RaccoonDev/push-docker-gcr@v1
        with:
          gcr_host: gcr.io
          image_name: btc-node-proxy
          image_tag: latest
